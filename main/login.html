<!DOCTYPE html>
<html>
<head>
 <title>一覧</title>
 <meta http-equiv="content-type" charset="utf-8">
 <link rel="stylesheet" href="../style.css">
</head>
<?php
$err = 'err';
$loginName = '';
require_once("../common/common.php");
if(isset($_POST['user'])){
$user = $_POST['user'];
}

if(isset($_POST['pass'])){
    $pass = $_POST['pass'];
    }

    try{

        //ログイン情報取得
       $pdo = DB_open();
    
        $sql = 'select count(*) num from t_login where user = ? and pass = ?';
        $stmtcnt = $pdo->prepare($sql);
        $stmtcnt->execute([$user, $pass]);

     
        if($stmtcnt->fetchColumn() > 0 ){
           
            //$sql = 'select * from t_login where user = ? and pass = ?';
            $sql = 'SELECT name ' 
                  .'FROM   t_user u ,t_login l '
                  .'WHERE  u.id = l.id '
                  .'AND    l.user = ? And l.pass = ?';
      
            $stmt = $pdo->prepare($sql);
            $stmt->execute([$user, $pass]);

            foreach ($stmt as $row) {
                $loginName = $row['name'];

            }
            
        }else{
            header('Location: ../index.html?error='. $err);
            die ();
        }

        $sql = 'SELECT u.id,u.name ' 
        .'FROM   t_user u ,t_login l '
        .'WHERE  u.id = l.id ';

        $stmt = $pdo->query($sql);
        $members = array();

        foreach ($stmt as $row) {
            $members[] = $row;
        }

    }catch (PDOException $e){
        print('Error:'.$e->getMessage());
        die();
    } 

?>
<body>
	<div align="left"" >
        <p><?php echo $loginName; ?>さんがログインしました。</p>
        <form action="../add/addform.html"　method="post" name="add" >
            <input type="submit" name="addbtn" value="新規登録" >
        </form>
        <form name="list">
            <table>
                <?php 
                foreach ($members as $row) {
                ?>
                <tr>
                    <td><?php echo $row['id']; ?></td>
                    <td><?php echo $row['name']; ?></td>
                </tr>
                <?php
                }
                ?>
            </table>
        </form>
<!--
		<form action = "main/login.html" method = "post">
			<p>KT-WORKS</p>
			<table class="mypage">
				<tr>
					<th>ユーザー名</th>
					<td><input type="text" name="user" value="<?php echo $user; ?>"</td>
				</tr>
				<tr>
					<th>パスワード</th>
					<td><input type="text" name="pass" ></td>
				</tr>			
			</table>
		    <div align="center" >
			    <input type="submit" name="login" value="ログイン">
		    </div >
        </form>
-->
    </div>
</body>